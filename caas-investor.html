<link rel="import" href="../polymer/polymer.html">

<!--
`caas-investor`
Polymer Investor Element for Crowdfunding as a Service Solutions

@demo demo/index.html 
-->

<dom-module id="caas-investor">
  <template>

    <iron-ajax
      id="getInvestorProfile"
      url="[[apiEndpoint]]/investors/[[investorId]]"
      handle-as="json"
      headers="[[_requestHeaders]]"
      method="GET"
      last-response="{{_investorData}}"
      on-response="_handleGetInvestorResponse"
      on-error="_handleGetInvestorError"
      auto="[[accessToken]]"
    ></iron-ajax>

    <iron-ajax
      id="subscription"
      url="[[apiEndpoint]]/investors/[[investorId]]/newsletter"
      body='{"subscribed": [[subscribedToNewsletter]]}'
      handle-as="json"
      content-type="application/json"
      headers="[[_requestHeaders]]"      
      method="POST"
      on-request="_handleSubscribtionRequestSent"
      on-response="_handleSubscribtionResponse"
      on-error="_handleSubscribtionResponseError"
    ></iron-ajax>    

    <iron-ajax
      id="updateInvestorProfile"
      url="[[apiEndpoint]]/investors/[[investorId]]"
      body='[[_updatedProfileBody]]'
      handle-as="json"
      content-type="application/json"
      headers="[[_requestHeaders]]"      
      method="PUT"
      on-request="_handleProfileUpdateRequestSent"
      on-response="_handleProfileUpdateResponse"
      on-error="_handleProfileUpdateResponseError"
    ></iron-ajax>   

  </template>

  <script>
    Polymer({

      is: 'caas-investor',

      properties: {
        /**
        * The Server side API endpoint
        */
        apiEndpoint: {
          type: String,
          notify: true
        },

        /**
        * The access token (JSON web token) associated with the current user session
        */
        accessToken: {
          type: String
        },        

        /**
        * The user id associated with the current user session
        */
        investorId: {
          type: String
        },

        /**
        * First Name
        */        
        firstName: {
          type: String,
          notify: true
        },

        /**
        * Last Name
        */        
        lastName: {
          type: String,
          notify: true
        },      

        /**
        * Exposes whether the user is subscribed to the newsletter
        */        
        subscribedToNewsletter: {
          type: Boolean,
          notify: true
        },

        /**
        * IBAN
        */        
        iban: {
          type: String,
          notify: true
        },

        /**
        * Bank Account Name
        */        
        bankAccountName: {
          type: String,
          notify: true
        },

        /**
        * Twitter Profile URL
        */        
        twitterUrl: {
          type: String,
          notify: true
        },

        /**
        * Facebook Profile URL
        */        
        facebookUrl: {
          type: String,
          notify: true
        },

        /**
        * LinkedIn Profile URL
        */        
        linkedinUrl: {
          type: String,
          notify: true
        },

        /**
        * Postal Address
        */        
        address: {
          type: Object,
          notify: true
        },    

        /**
        * Exposes the currently invested capital, in euros.
        */        
        currentInvestment: {
          type: Number,
          notify: true,
          readOnly: true
        },

        /**
        * Exposes the all-time total invested capital, in euros.
        */        
        totalInvestment: {
          type: Number,
          notify: true,
          readOnly: true
        },      

        _updatedProfileBody: {
          type: Object,
          value: {},
          computed: '_computeUpdatedProfileBody(firstName, lastName, privacy, address.*)'
        },

        _requestHeaders: {
          type: Object,
          computed: '_computeRequestHeaders(accessToken)'
        },

        _investorData: {
          type: Object,
          value: {},
          observer: '_setInvestorProfile'
        }        
      },

      getInvestorProfile: function () {
        this.$.getInvestorProfile.generateRequest();
      },

      saveNewsletterSubscription: function (evt) {
        this.$.subscription.generateRequest();
      },

      saveUpdatedProfile: function (evt) {
        this.$.updateInvestorProfile.generateRequest();
      },

      _computeRequestHeaders: function(accessToken) {
        return {
          'authorization': 'Bearer ' + accessToken 
        }
      }, 

      _setInvestorProfile: function (investorData) {
        this.set('firstName', investorData.firstName);
        this.set('lastName', investorData.lastName);
        this.set('subscribedToNewsletter', investorData.newsletter || 0);
        this.set('iban', investorData.iban);
        this.set('bankAccountName', investorData.bankTenaam);
        this.set('twitterUrl', investorData.twitter);
        this.set('facebookUrl', investorData.facebook);
        this.set('linkedinUrl', investorData.linkedin);
        this.set('address', investorData.address);
        this.setCurrentInvestment(investorData.currentlyInvestedCapital);
        this.setTotalInvestment(investorData.totalInvestments);
      },

      _computeUpdatedProfileBody: function (firstName, lastName, privacy, addressChange) {
        var address = addressChange.base;
        return {
          'firstName': firstName,
          'lastName': lastName,
          'address': address
        }
      },

      _handleGetInvestorResponse: function(response) {
        this.fire('investor-details-obtained')
      },         

      _handleGetInvestorError: function(evt) {
        this.fire('investor-details-error', {
          message: evt.detail.error.message,
          response: evt.detail.request.xhr.response
        });
      },      

      _handleSubscribtionRequestSent: function (evt) {
        this.fire('subscribe-request-sent')
      },

      _handleSubscribtionResponse: function (evt) {
        this.fire('subscribe-request-response')

        // Generate GET request on succesfull POST
        this.$.getInvestorProfile.generateRequest();
      },

      _handleSubscribtionResponseError: function (evt) {
        this.fire('subscribe-request-error', {
          message: evt.detail.error.message,
          response: evt.detail.request.xhr.response
        });
      },

      _handleProfileUpdateRequestSent: function (evt) {
        this.fire('update-profile-request-sent')
      },

      _handleProfileUpdateResponse: function (evt) {
        this.fire('update-profile-request-response')

        // Generate GET request on succesfull PUT
        this.$.getInvestorProfile.generateRequest();
      },

      _handleProfileUpdateResponseError: function (evt) {
        this.fire('update-profile-request-error', {
          message: evt.detail.error.message,
          response: evt.detail.request.xhr.response
        });
      }      
    });
  </script>
</dom-module>
